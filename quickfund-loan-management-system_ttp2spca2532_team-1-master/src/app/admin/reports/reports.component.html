<!-- Header Section with Back Link and Title Side by Side -->
<div class="d-flex align-items-center gap-4 mb-4">
  <div class="flex-shrink-0">
    <a routerLink="/admin/dashboard" class="text-decoration-none text-muted">
      <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
    </a>
  </div>
  <div class="flex-grow-1">
    <h1 class="heading display-6 fw-bold text-dark mb-0">Reports & Analytics</h1>
    <p class="text-muted mb-0">Comprehensive repayment and performance reports</p>
  </div>
</div>

<!-- KPI Metrics Cards -->
<div class="row g-3 mb-4">
  <div class="col-lg-3 col-md-6" *ngFor="let metric of kpiMetrics">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="me-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center" 
               [ngClass]="'bg-' + metric.color + '-subtle'"
               style="width: 48px; height: 48px;">
            <i [class]="metric.icon + ' fs-5'" [ngClass]="'text-' + metric.color"></i>
          </div>
        </div>
        <div class="flex-grow-1">
          <h6 class="card-title text-muted mb-1 small fw-semibold">{{ metric.title }}</h6>
          <div class="fw-bold fs-4 mb-1" [ngClass]="'text-' + metric.color">{{ metric.value }}</div>
          <div class="small" [ngClass]="'subtitle-' + metric.color">{{ metric.subtitle }}</div>
        </div>
      </div>
      <div class="card-footer bg-transparent border-0 p-0">
        <div class="border-start border-4" [ngClass]="'border-' + metric.color"></div>
      </div>
    </div>
  </div>
</div>

<!-- Repayment History Section -->
<div class="card border-0 shadow-sm repayment-history-section">
  <div class="card-body p-4">
    <!-- Section Header -->
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-graph-up-arrow fs-5 me-2 text-primary"></i>
      <h2 class="h4 fw-semibold mb-0">Repayment History</h2>
    </div>
    <p class="text-muted mb-4">Detailed repayment transactions with filtering and export options</p>

    <!-- Filters and Export Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <div class="d-flex gap-2">
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-calendar me-2"></i>{{ selectedTimeFilter }}
          </button>
          <ul class="dropdown-menu">
            <li *ngFor="let filter of timeFilters">
              <a class="dropdown-item" href="#" (click)="selectedTimeFilter = filter; onFilterChange(); $event.preventDefault()">{{ filter }}</a>
            </li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-funnel me-2"></i>{{ selectedCustomerFilter }}
          </button>
          <ul class="dropdown-menu">
            <li *ngFor="let filter of customerFilters">
              <a class="dropdown-item" href="#" (click)="selectedCustomerFilter = filter; onFilterChange(); $event.preventDefault()">{{ filter }}</a>
            </li>
          </ul>
        </div>
      </div>
      
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" (click)="exportCSV()">
          <i class="bi bi-download me-2"></i>Export CSV
        </button>
        <button class="btn btn-outline-primary" (click)="exportPDF()">
          <i class="bi bi-download me-2"></i>Export PDF
        </button>
      </div>
    </div>

    <!-- Repayment History Table -->
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th scope="col">Date</th>
            <th scope="col">Customer</th>
            <th scope="col">Loan ID</th>
            <th scope="col">Amount</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let transaction of getFilteredRepaymentHistory()">
            <td>{{ formatDate(transaction.date) }}</td>
            <td>{{ transaction.customer }}</td>
            <td>{{ transaction.loanId }}</td>
            <td class="fw-semibold text-success">{{ formatCurrency(transaction.amount) }}</td>
            <td>
              <span class="badge bg-success-subtle text-success">{{ transaction.status }}</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Analytics Report Buttons Section -->
<div class="mt-5">
  <div class="card border-0 shadow-lg">
    <div class="card-body p-5">
      <div class="text-center mb-5">
        <div class="d-inline-flex align-items-center bg-primary-subtle rounded-pill px-4 py-2 mb-3">
          <i class="bi bi-graph-up-arrow text-primary me-2"></i>
          <span class="text-primary fw-semibold">Advanced Analytics</span>
        </div>
        <h3 class="h3 fw-bold text-dark mb-2"><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Detailed Analytics Reports</h3>
        <p class="text-muted fs-5 mb-0">Explore comprehensive insights and performance metrics</p>
      </div>
      
      <div class="row g-4">
        <!-- 1. Loan Portfolio Overview -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card portfolio-card" (click)="showReport('portfolio')">
            <div class="card-icon">
              <i class="bi bi-pie-chart-fill"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Loan Portfolio Overview</h4>
              <p class="card-description">Distribution by type & status</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-success"></i>
                  {{ formatIndianCurrency(totalPortfolio) }} Portfolio
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-primary"></i>
                  {{ activeLoansCount }} Active Loans
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 2. Disbursement Trends -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card disbursement-card" (click)="showReport('disbursement')">
            <div class="card-icon">
              <i class="bi bi-graph-up"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Disbursement Trends</h4>
              <p class="card-description">Monthly trends & growth</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-success"></i>
                  +{{ (repaymentRate * 0.3) | number:'1.1-1' }}% Growth
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-info"></i>
                  {{ formatIndianCurrency(totalPortfolio * 1.2) }} Current Year
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 3. Repayment Rates -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card repayment-card" (click)="showReport('repayment')">
            <div class="card-icon">
              <i class="bi bi-bar-chart-fill"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Repayment & Default Rates</h4>
              <p class="card-description">Performance metrics</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-success"></i>
                  {{ repaymentRate | number:'1.1-1' }}% Repayment Rate
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-warning"></i>
                  {{ activeLoansCount }} Loans Processed
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 4. Interest Revenue -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card revenue-card" (click)="showReport('revenue')">
            <div class="card-icon">
              <i class="bi bi-cash-stack"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Interest Revenue</h4>
              <p class="card-description">Monthly revenue breakdown</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-success"></i>
                  {{ formatIndianCurrency(totalRevenue) }} Annual Revenue
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-success"></i>
                  +{{ (repaymentRate * 0.1) | number:'1.1-1' }}% Growth
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 5. Risk Analysis -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card risk-card" (click)="showReport('risk')">
            <div class="card-icon">
              <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Risk Analysis</h4>
              <p class="card-description">Regional risk assessment</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-danger"></i>
                  {{ riskScore | number:'1.1-1' }}% Risk Score
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-warning"></i>
                  {{ Math.min(10, Math.max(3, activeLoansCount / 5)) | number:'0.0-0' }} Regions Analyzed
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 6. Customer Segmentation -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card segmentation-card" (click)="showReport('segmentation')">
            <div class="card-icon">
              <i class="bi bi-people-fill"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Customer Segmentation</h4>
              <p class="card-description">Customer type distribution</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-primary"></i>
                  {{ totalCustomers }} Total Customers
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-info"></i>
                  {{ Math.min(8, Math.max(3, totalCustomers / 50)) | number:'0.0-0' }} Customer Types
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 7. Approval Funnel -->
        <div class="col-lg-4 col-md-6">
          <div class="report-card funnel-card" (click)="showReport('funnel')">
            <div class="card-icon">
              <i class="bi bi-funnel-fill"></i>
            </div>
            <div class="card-content">
              <h4 class="card-title">Approval Funnel</h4>
              <p class="card-description">Conversion rates</p>
              <div class="card-stats">
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-success"></i>
                  {{ (repaymentRate * 0.8) | number:'1.1-1' }}% Conversion Rate
                </span>
                <span class="stat-item">
                  <i class="bi bi-circle-fill text-primary"></i>
                  {{ (totalCustomers * 2.5) | number:'0.0-0' }} Applications
                </span>
              </div>
            </div>
            <div class="card-arrow">
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom CTA -->
      <div class="text-center mt-5 pt-4 border-top">
        <div class="d-inline-flex align-items-center bg-light rounded-pill px-4 py-2">
          <i class="bi bi-info-circle text-muted me-2"></i>
          <span class="text-muted small">Click any report above to view detailed analytics</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Beautiful Custom Report Modals -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <!-- Modal Header -->
      <div class="modal-header border-0 pb-0" [ngClass]="'bg-gradient-' + currentReport.color">
        <div class="d-flex align-items-center w-100">
          <div class="bg-white bg-opacity-20 rounded-circle p-3 me-3">
            <i [class]="currentReport.icon + ' text-white fs-4'"></i>
          </div>
          <div class="flex-grow-1">
            <h4 class="modal-title text-white mb-1 fw-bold" id="reportModalLabel">{{ currentReport.title }}</h4>
            <p class="text-white-50 mb-0">{{ currentReport.subtitle }}</p>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-4">
        <!-- Key Metrics Section -->
        <div class="row g-3 mb-4" *ngIf="currentReport.metrics">
          <div class="col-md-3" *ngFor="let metric of currentReport.metrics">
            <div class="text-center p-3 rounded-3" [ngClass]="'bg-' + currentReport.color + '-subtle'">
              <div class="fw-bold fs-4 mb-1" [ngClass]="'text-' + currentReport.color">{{ formatAmountINR(metric.value) }}</div>
              <div class="small text-muted">{{ metric.label }}</div>
            </div>
          </div>
        </div>

        <!-- Chart/Visual Section -->
        <div class="mb-4" *ngIf="currentReport.chartData">
          <h6 class="fw-semibold mb-3">{{ currentReport.chartTitle }}</h6>
          <div class="chart-container">
            <div class="row g-3">
              <div class="col-md-6" *ngFor="let item of currentReport.chartData">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small">{{ item.label }}</span>
                  <span class="fw-semibold">{{ formatAmountINR(item.value) }}</span>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar" 
                       [ngClass]="'bg-' + currentReport.color"
                       [style.width.%]="item.percentage"></div>
                </div>
                <div class="d-flex justify-content-between text-muted small mt-1">
                  <span>{{ item.count }}</span>
                  <span>{{ formatAmountINR(item.amount) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table Section -->
        <div class="mb-4" *ngIf="currentReport.tableData">
          <h6 class="fw-semibold mb-3">{{ currentReport.tableTitle }}</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th *ngFor="let header of currentReport.tableHeaders" class="small fw-semibold">{{ header }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of currentReport.tableData">
                  <td *ngFor="let cell of row" [ngClass]="cell.class">{{ formatAmountINR(cell.value) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Insights Section -->
        <div class="bg-light rounded-3 p-3" *ngIf="currentReport.insights">
          <h6 class="fw-semibold mb-2"><i class="bi bi-lightbulb me-2 text-warning"></i>Key Insights</h6>
          <ul class="mb-0 small">
            <li *ngFor="let insight of currentReport.insights">{{ insight }}</li>
          </ul>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
        
        <!-- Export Options -->
        <div class="dropdown me-2">
          <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-download me-2"></i>Export Report
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" (click)="exportReportAsCSV(prepareReportDataForExport()); $event.preventDefault()">
              <i class="bi bi-file-earmark-text me-2 text-success"></i>Export as CSV
            </a></li>
            <li><a class="dropdown-item" href="#" (click)="exportReportAsPDF(prepareReportDataForExport()); $event.preventDefault()">
              <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>Export as PDF
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
