<div class="container pt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Header aligned with left column -->
      <div class="row mb-4">
        <div class="col-md-6">
          <a
            routerLink="/user/dashboard"
            class="text-decoration-none text-dark fw-semibold mb-2 d-inline-block"
          >
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
          <h3 class="fw-bold mb-1">Make a Repayment</h3>
          <p class="text-muted small mb-0">Pay towards your active loans</p>
        </div>
      </div>

      <!-- Main 2-column layout -->
      <div class="row g-4">
        <!-- Left: Form Card -->
        <div class="col-md-6">
          <div class="card p-3 rounded-4 shadow-sm">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-file-invoice me-2 text-primary small-icon"></i>
              <h6 class="fw-semibold mb-0">Payment Details</h6>
            </div>
            <p class="text-muted small mb-3">
              Select a loan and enter the payment amount
            </p>

            <!-- Success/Error Messages -->
            <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show mb-3" role="alert">
              <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
            </div>
            
            <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
              <i class="fas fa-exclamation-circle me-2"></i>{{ errorMessage }}
            </div>

            <form (ngSubmit)="onSubmit()" #repaymentForm="ngForm">
              <!-- Loan Dropdown -->
              <div class="mb-2">
                <label class="form-label small fw-semibold">Select Loan</label>
                <select
                  class="form-select form-select-sm"
                  required
                  [(ngModel)]="form.loanId"
                  name="loanId"
                  (ngModelChange)="onLoanChange()"
                >
                  <option value="" disabled selected>
                    Choose a loan to pay
                  </option>
                  <option *ngFor="let loan of loans" [value]="loan.id">
                    {{ loan.purpose }} (Loan #{{ loan.id }}) - {{ loan.status }}
                  </option>
                </select>
              </div>

              <!-- Amount Input -->
              <div class="mb-2">
                <label class="form-label small fw-semibold"
                  >Payment Amount</label
                >
                <div class="input-group input-group-sm">
                  <span class="input-group-text border-0">
                    <i class="fas fa-rupee-sign text-muted"></i>
                  </span>
                  <input
                    type="number"
                    class="form-control border-start-0"
                    placeholder="Enter payment amount"
                    min="1"
                    required
                    [(ngModel)]="form.amount"
                    name="amount"
                  />
                </div>
              </div>

            

              <!-- Method Dropdown -->
              <div class="mb-2">
                <label class="form-label small fw-semibold"
                  >Payment Method</label
                >
                <select
                  class="form-select form-select-sm"
                  required
                  [(ngModel)]="form.method"
                  name="method"
                >
                  <option value="" disabled selected>
                    Select payment method
                  </option>
                  <option value="credit">Credit Card</option>
                  <option value="debit">Debit Card</option>
                  <option value="bank">Bank Transfer</option>
                  <option value="paypal">PayPal</option>
                </select>
              </div>

              <!-- Button -->
              <button
                class="btn btn-sm w-100 gradient-btn mt-3"
                type="submit"
                [disabled]="!repaymentForm.valid || isSubmitting"
              >
                <span *ngIf="isSubmitting">
                  <i class="fas fa-spinner fa-spin me-2"></i>Processing...
                </span>
                <span *ngIf="!isSubmitting">
                  <i class="fas fa-credit-card me-2"></i>Process Payment
                </span>
              </button>
            </form>
          </div>
        </div>

        <!-- Right: Info Cards -->
        <div class="col-md-6 d-flex flex-column gap-3">
          <!-- Info Card 1: Loan Summary -->
          <div class="card loan-summary-card p-4 mb-3">
            <ng-container *ngIf="selectedLoan; else noLoan">
              <div class="fw-bold fs-6 mb-1">Loan Summary</div>
              <div class="text-muted mb-3" style="font-size:13px;">Details of the selected loan</div>
              <div class="summary-row"><span class="label">Loan ID</span><span class="value fw-bold">L{{ selectedLoan.id }}</span></div>
              <div class="summary-row"><span class="label">Purpose</span><span class="value fw-semibold">{{ selectedLoan.purpose }}</span></div>
              <div class="summary-row"><span class="label">Original Amount</span><span class="value text-dark fw-bold">₹ {{ selectedLoan.amount | number:'1.0-0' }}</span></div>
              <div class="summary-row"><span class="label">Total Paid</span><span class="value text-success fw-bold">₹ {{ totalPaid | number:'1.0-0' }}</span></div>
              <div class="summary-row"><span class="label">Outstanding</span><span class="value text-danger fw-bold">₹ {{ outstanding | number:'1.0-0' }}</span></div>
              <div class="summary-row"><span class="label">Status</span><span class="value"><span class="status-pill" [ngClass]="{'active': selectedLoan.status === 'Active', 'closed': selectedLoan.status === 'Closed'}">{{ selectedLoan.status.toLowerCase() }}</span></span></div>
            </ng-container>
            <ng-template #noLoan>
              <div class="mb-2 py-3 text-center">
                <span class="fw-bold fs-6">Loan Summary</span>
                <div class="text-muted mb-3" style="font-size:13px;">Details of the selected loan</div>
                <div class="text-muted small mb-0 text-center">Choose a loan from the dropdown to see its details</div>
              </div>
            </ng-template>
          </div>

          <!-- Info Card 2: Recent Payments -->
          <div class="card p-4 recent-payments-card">
            <div class="d-flex align-items-center gap-2 mb-3">
              <i class="fas fa-calendar-alt text-primary"></i>
              <span class="fw-semibold">Recent Payments</span>
            </div>
            <ng-container *ngIf="selectedLoan && selectedRepayments.length > 0; else noRepayments">
              <div class="payment-list">
                <div *ngFor="let rep of selectedRepayments" class="payment-item mb-2">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="fw-bold">₹ {{ rep.amount | number:'1.0-0' }}</span>
                      <div class="text-muted small">{{ formatDate(rep.date) }}</div>
                    </div>
                    <span class="status-pill paid">Paid</span>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noRepayments>
              <p class="text-muted small mb-0 py-4 text-center">
                Select a loan to view payment history
              </p>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
